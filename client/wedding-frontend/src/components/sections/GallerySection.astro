---
import 'glightbox/dist/css/glightbox.min.css';
const photos = [
  { base: '1-pre-wedding_insta', alt: 'Sara e Artur - 1' },
  { base: '2-pre-wedding_insta', alt: 'Sara e Artur - 2' },
  { base: '14-pre-wedding_insta', alt: 'Sara e Artur - 3' },
  { base: '18-pre-wedding_insta', alt: 'Sara e Artur - 4' },
  { base: '33-pre-wedding_insta', alt: 'Sara e Artur - 5' },
  { base: '37-pre-wedding_insta', alt: 'Sara e Artur - 6' },
  { base: '41-pre-wedding_insta', alt: 'Sara e Artur - 7' },
  { base: '46-pre-wedding_insta', alt: 'Sara e Artur - 8' },
  { base: '52-pre-wedding_insta', alt: 'Sara e Artur - 9' },
  { base: '60-pre-wedding_insta', alt: 'Sara e Artur - 10' },
  { base: '67-pre-wedding_insta', alt: 'Sara e Artur - 11' },
  { base: '71-pre-wedding_insta', alt: 'Sara e Artur - 12' },
];
const sizes = [400, 800, 1200, 2000];
const srcset = (base, ext) => sizes.map((w) => `/gallery/${base}-${w}.${ext} ${w}w`).join(', ');
---

<section id="galeria" class="py-16 bg-gradient-to-br from-slate-50 via-white to-blue-50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Title -->
    <div class="text-center mb-12">
      <h2 class="text-4xl md:text-5xl font-bold text-slate-700 mb-6">Nossa Galeria</h2>
      <p class="text-lg text-slate-600 max-w-3xl mx-auto leading-relaxed">
        Momentos especiais que serão preenchidos com as memórias do nosso grande dia
      </p>
    </div>

    <!-- Gallery Grid -->
    <div class="space-y-6">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        {
          photos.map((p, i) => (
            <a
              href={`/gallery/${p.base}-2000.jpg`}
              class="glightbox block group"
              data-gallery="wedding"
              aria-label={p.alt}
            >
              <picture>
                <source
                  type="image/avif"
                  srcset={srcset(p.base, 'avif')}
                  sizes="(max-width: 768px) 50vw, 33vw"
                />
                <source
                  type="image/webp"
                  srcset={srcset(p.base, 'webp')}
                  sizes="(max-width: 768px) 50vw, 33vw"
                />
                <img
                  src={`/gallery/${p.base}-800.jpg`}
                  alt={p.alt}
                  loading={i === 0 ? 'eager' : 'lazy'}
                  decoding="async"
                  fetchpriority={i === 0 ? 'high' : 'auto'}
                  width="800"
                  height="800"
                  class="aspect-square w-full object-cover rounded-lg border-2 border-slate-200"
                />
              </picture>
            </a>
          ))
        }
      </div>
    </div>

    <script type="module">
      async function loadGLightboxFromCDN() {
        const module = await import(
          'https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js'
        );
        return module.default ?? module.GLightbox ?? window.GLightbox ?? module;
      }

      async function initLightbox() {
        if (window._gLightbox) return;
        try {
          const GLightboxLib = await loadGLightboxFromCDN();
          const factory =
            typeof GLightboxLib === 'function'
              ? GLightboxLib
              : (GLightboxLib.GLightbox ?? GLightboxLib.default ?? GLightboxLib);
          window._gLightbox = factory({
            selector: '.glightbox',
            touchNavigation: true,
            loop: true,
            closeButton: true,
            closeOnOutsideClick: true,
          });
        } catch (err) {
          console.error('Failed to load GLightbox:', err);
        }
      }

      function destroyLightbox() {
        if (window._gLightbox) {
          try {
            window._gLightbox.destroy();
          } catch (e) {
            /* ignore */
          }
          window._gLightbox = null;
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLightbox, { once: true });
      } else {
        initLightbox();
      }

      window.addEventListener('astro:before-swap', () => destroyLightbox());
      window.addEventListener('astro:page-load', () => {
        destroyLightbox();
        initLightbox();
      });
    </script>
  </div>
</section>
